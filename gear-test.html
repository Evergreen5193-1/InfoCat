<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfoCat - Equipment Set Builder</title>
    <link rel="icon" type="image/png" href="infocat-smaller.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111118;
        }
        .brand-purple { color: #9D8DF1; }
        .bg-brand-purple { background-color: #9D8DF1; }
        .border-brand-purple { border-color: #9D8DF1; }
        .glassmorphism {
            background: rgba(30, 30, 40, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(157, 141, 241, 0.15);
        }
        .hero-bg {
            background-color: #111118;
            background-image: 
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(157, 141, 241, 0.1), transparent);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a22; }
        ::-webkit-scrollbar-thumb { background: #4a4a5a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9D8DF1; }

        .rarity-Legendary { border-color: #ff8000; }
        .rarity-Epic { border-color: #a335ee; }
        
        #gear-modal::-webkit-scrollbar { width: 8px; }
        #gear-modal::-webkit-scrollbar-track { background: #2a2a35; }
        #gear-modal::-webkit-scrollbar-thumb { background: #5a5a6a; }
        #gear-modal::-webkit-scrollbar-thumb:hover { background: #9D8DF1; }
    </style>
</head>
<body class="text-gray-200">

    <!-- Header -->
    <header id="header" class="sticky top-0 left-0 right-0 z-40 transition-all duration-300 glassmorphism">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <a href="index.html" class="flex items-center space-x-3">
                    <img src="Infocat.png" alt="InfoCat Logo" class="h-12 w-12 rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/50x50/9D8DF1/ffffff?text=iC';">
                    <span class="hidden sm:block text-2xl font-bold text-white">InfoCat</span>
                </a>
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="index.html#trackers" class="hover:text-brand-purple transition-colors duration-300">Trackers</a>
                    <a href="calculators.html" class="hover:text-brand-purple transition-colors duration-300">Calculators</a>
                    <a href="about.html" class="hover:text-brand-purple transition-colors duration-300">About</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="text-center mb-12 hero-bg py-10 rounded-2xl">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white">Equipment Set Builder</h1>
            <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-400">Craft the perfect gear set, refine it, and see the total stats instantly.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Equipment Slots -->
            <div id="equipment-layout" class="lg:col-span-2 flex justify-center items-center py-8">
                 <!-- Layout is generated by JS -->
                 <p class="text-gray-500">Loading equipment data...</p>
            </div>

            <!-- Right Column: Stats Panel -->
            <div class="lg:col-span-1">
                <div id="stats-panel" class="p-6 glassmorphism rounded-2xl sticky top-24">
                    <h2 class="text-2xl font-bold text-white mb-4">Total Stats</h2>
                    <div id="stats-output" class="space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-2">
                        <p class="text-gray-500">Select equipment to see total stats...</p>
                    </div>
                    <button id="reset-button" class="mt-6 w-full bg-red-600/80 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Reset</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Gear Selection Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div id="modal-content" class="glassmorphism rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 id="modal-title" class="text-xl font-bold text-white">Select Equipment</h2>
                <button id="close-modal-button" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="p-4">
                <input type="text" id="search-input" class="w-full bg-gray-900/70 border-gray-700 rounded-lg py-2 px-4 text-white focus:ring-2 focus:ring-brand-purple focus:border-transparent" placeholder="Search for gear...">
            </div>
            <div id="gear-modal" class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto">
                <!-- Gear items will be populated here -->
            </div>
        </div>
    </div>
    
    <script>
        // --- GLOBAL STATE ---
        let allGear = [];
        const statKeys = [
            'Infantry Attack', 'Infantry Defense', 'Infantry Health',
            'Cavalry Attack', 'Cavalry Defense', 'Cavalry Health',
            'Archer Attack', 'Archer Defense', 'Archer Health'
        ];
        let selectedGear = {};
        let currentSlot = '';

        // --- UTILITY FUNCTIONS ---
        function csvToJson(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(v => v.replace(/"/g, ''));
                const obj = {};
                headers.forEach((header, i) => {
                    const value = values[i];
                    if (statKeys.includes(header) || header === 'Gold Cost' || header === 'Material Cost') {
                        obj[header] = parseFloat(value) || 0;
                    } else {
                        obj[header] = value;
                    }
                });
                if (obj.Name.toLowerCase().includes('helm') && obj.Slot !== 'Helmet') {
                    obj.Slot = 'Helmet';
                }
                return obj;
            });
        }

        // --- DOM ELEMENTS ---
        const layoutContainer = document.getElementById('equipment-layout');
        const statsOutput = document.getElementById('stats-output');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const gearModal = document.getElementById('gear-modal');
        const searchInput = document.getElementById('search-input');
        const closeModalButton = document.getElementById('close-modal-button');
        const resetButton = document.getElementById('reset-button');

        // --- RENDER FUNCTIONS ---
        function renderLayout() {
            const slotConfig = {
                'Helmet': { row: 1, col: 2, icon: 'üõ°Ô∏è' },
                'Chest': { row: 2, col: 2, icon: 'üëï' },
                'Weapon': { row: 3, col: 1, icon: '‚öîÔ∏è' },
                'Gloves': { row: 3, col: 3, icon: 'üß§' },
                'Legs': { row: 4, col: 2, icon: 'üëñ' },
                'Accessory_1': { row: 5, col: 1, icon: 'üíç' },
                'Accessory_2': { row: 5, col: 3, icon: 'üíç' },
                'Boots': { row: 6, col: 2, icon: 'üë¢' }
            };

            layoutContainer.innerHTML = `
                <div class="grid grid-cols-3 gap-y-2 place-items-center" style="width: 384px; height: 576px;">
                    ${Object.entries(slotConfig).map(([slotKey, {row, col, icon}]) => `
                        <div class="flex items-center justify-center" style="grid-row: ${row}; grid-column: ${col};">
                           ${renderSlot(slotKey, icon)}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderSlot(slotKey, icon) {
            const gear = selectedGear[slotKey];
            const displaySlotName = slotKey.replace(/_\d/,'');
            const rarityClass = gear ? `rarity-${gear.Rarity}` : '';
            const iconicGlow = gear && gear['Is Iconic?'] === 'Yes' ? 'shadow-[0_0_15px_rgba(255,215,0,0.7)]' : '';

            return `
                <div class="w-28 h-28 relative group">
                    <div class="p-2 glassmorphism rounded-xl aspect-square flex flex-col justify-center items-center text-center cursor-pointer hover:bg-gray-700/50 transition-colors" data-slot="${slotKey}">
                        ${gear ? `
                            <div class="relative">
                                <img src="${gear.Icon}" alt="${gear.Name}" class="h-16 w-16 mx-auto ${iconicGlow} rounded-md">
                                <div class="absolute -top-1 -right-1 bg-gray-900 rounded-full px-1.5 py-0.5 text-xs font-bold border ${rarityClass}">${gear.Rarity.substring(0,1)}</div>
                                <div class="absolute -bottom-1 -right-1 bg-brand-purple text-white rounded-full h-5 w-5 flex items-center justify-center text-xs font-bold">${gear.level}</div>
                            </div>
                        ` : `
                            <div class="w-full h-full border-2 border-dashed border-gray-600 rounded-xl flex flex-col justify-center items-center">
                                <p class="text-3xl text-gray-500">${icon}</p>
                                <p class="mt-1 text-xs text-gray-400">${displaySlotName}</p>
                            </div>
                        `}
                    </div>
                    ${gear ? `
                        <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-max p-2 glassmorphism rounded-lg text-xs opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1 z-10">
                            <button class="refine-btn bg-gray-700 hover:bg-gray-600 rounded-full h-5 w-5" data-slot="${slotKey}" data-change="-1">-</button>
                            <span>Refine: ${gear.level}</span>
                            <button class="refine-btn bg-gray-700 hover:bg-gray-600 rounded-full h-5 w-5" data-slot="${slotKey}" data-change="1">+</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderStats() {
            const totalStats = {};
            const totalCosts = { gold: 0, Legendary: 0, Epic: 0 };
            const refinementBonus = 0.05;

            statKeys.forEach(key => totalStats[key] = 0);

            for (const gear of Object.values(selectedGear)) {
                if (gear) {
                    totalCosts.gold += gear['Gold Cost'];
                    if (totalCosts[gear.Rarity] !== undefined) {
                       totalCosts[gear.Rarity] += gear['Material Cost'];
                    }

                    const levelBonus = 1 + ( (gear.level - 1) * refinementBonus );

                    for (const statName of statKeys) {
                        if (gear[statName] > 0) {
                            totalStats[statName] += gear[statName] * levelBonus;
                        }
                    }
                }
            }

            statsOutput.innerHTML = '';
            let hasContent = false;
            
            if (totalCosts.gold > 0 || totalCosts.Legendary > 0 || totalCosts.Epic > 0) {
                hasContent = true;
                let costsHtml = `<h3 class="font-bold text-lg text-white">Total Crafting Costs</h3>`;
                costsHtml += '<div class="space-y-1 pl-2">';
                if(totalCosts.gold > 0) costsHtml += `<div class="flex justify-between"><span>Gold:</span> <span class="font-semibold">${totalCosts.gold.toLocaleString()}</span></div>`;
                if(totalCosts.Legendary > 0) costsHtml += `<div class="flex justify-between"><span>Legendary Materials:</span> <span class="font-semibold">${totalCosts.Legendary.toLocaleString()}</span></div>`;
                if(totalCosts.Epic > 0) costsHtml += `<div class="flex justify-between"><span>Epic Materials:</span> <span class="font-semibold">${totalCosts.Epic.toLocaleString()}</span></div>`;
                costsHtml += '</div>';
                statsOutput.innerHTML += costsHtml;
            }

            const statsOrder = ['Infantry', 'Cavalry', 'Archer'];
            statsOrder.forEach(troopType => {
                const attack = totalStats[`${troopType} Attack`];
                const defense = totalStats[`${troopType} Defense`];
                const health = totalStats[`${troopType} Health`];

                if (attack > 0 || defense > 0 || health > 0) {
                    hasContent = true;
                    let statsHtml = `<h3 class="font-bold text-lg text-white mt-4">${troopType} Stats</h3>`;
                    statsHtml += '<div class="space-y-1 pl-2">';
                    if (attack > 0) statsHtml += `<div class="flex justify-between"><span>Attack:</span> <span class="font-semibold text-green-400">+${attack.toFixed(2)}%</span></div>`;
                    if (defense > 0) statsHtml += `<div class="flex justify-between"><span>Defense:</span> <span class="font-semibold text-green-400">+${defense.toFixed(2)}%</span></div>`;
                    if (health > 0) statsHtml += `<div class="flex justify-between"><span>Health:</span> <span class="font-semibold text-green-400">+${health.toFixed(2)}%</span></div>`;
                    statsHtml += '</div>';
                    statsOutput.innerHTML += statsHtml;
                }
            });

            if (!hasContent) {
                statsOutput.innerHTML = '<p class="text-gray-500">Select equipment to see total stats...</p>';
            }
        }

        function populateModal(slot, searchTerm = '') {
            currentSlot = slot;
            const slotType = slot.includes('Accessory') ? 'Accessory' : slot;
            modalTitle.textContent = `Select ${slotType}`;
            gearModal.innerHTML = '';

            const filteredGear = allGear.filter(g => 
                g.Slot === slotType && 
                g.Name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            filteredGear.forEach(gear => {
                const rarityClass = `rarity-${gear.Rarity}`;
                const iconicGlow = gear['Is Iconic?'] === 'Yes' ? 'shadow-[0_0_10px_rgba(255,215,0,0.5)]' : '';
                gearModal.innerHTML += `
                    <div class="p-3 glassmorphism rounded-xl text-center cursor-pointer hover:bg-gray-700/70 transition-colors" data-gear-name="${gear.Name}">
                        <div class="relative">
                           <img src="${gear.Icon}" alt="${gear.Name}" class="h-16 w-16 mx-auto ${iconicGlow} rounded-md">
                           <div class="absolute -top-1 -right-1 bg-gray-900 rounded-full px-1.5 py-0.5 text-xs font-bold border ${rarityClass}">${gear.Rarity.substring(0,1)}</div>
                        </div>
                        <p class="mt-2 text-xs font-semibold">${gear.Name}</p>
                    </div>
                `;
            });
        }
        
        // --- EVENT HANDLERS ---
        function handleSlotClick(e) {
            const slotElement = e.target.closest('[data-slot]');
            if (slotElement) {
                const slot = slotElement.dataset.slot;
                searchInput.value = '';
                populateModal(slot);
                modalBackdrop.classList.remove('hidden');
            }
        }

        function handleGearSelect(e) {
            const gearElement = e.target.closest('[data-gear-name]');
            if (gearElement) {
                const gearName = gearElement.dataset.gearName;
                const newGear = { ...allGear.find(g => g.Name === gearName), level: 1 };
                selectedGear[currentSlot] = newGear;
                closeModal();
                renderAll();
            }
        }
        
        function handleRefine(e) {
             const refineButton = e.target.closest('.refine-btn');
             if(refineButton) {
                 e.stopPropagation(); 
                 const slot = refineButton.dataset.slot;
                 const change = parseInt(refineButton.dataset.change, 10);
                 const gear = selectedGear[slot];
                 if(gear) {
                     let newLevel = gear.level + change;
                     if (newLevel < 1) newLevel = 1;
                     if (newLevel > 5) newLevel = 5;
                     gear.level = newLevel;
                     renderAll();
                 }
             }
        }

        function closeModal() {
            modalBackdrop.classList.add('hidden');
        }

        function handleReset() {
            selectedGear = {};
            renderAll();
        }
        
        function renderAll() {
            renderLayout();
            renderStats();
        }

        // --- INITIALIZATION ---
        async function init() {
            try {
                const response = await fetch('gear.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvData = await response.text();
                allGear = csvToJson(csvData);
                
                renderAll();
                
                layoutContainer.addEventListener('click', handleSlotClick);
                layoutContainer.addEventListener('click', handleRefine);
                closeModalButton.addEventListener('click', closeModal);
                modalBackdrop.addEventListener('click', (e) => {
                    if(e.target === modalBackdrop) closeModal();
                });
                gearModal.addEventListener('click', handleGearSelect);
                searchInput.addEventListener('input', () => populateModal(currentSlot, searchInput.value));
                resetButton.addEventListener('click', handleReset);
                
            } catch (error) {
                console.error("Failed to load or process gear data:", error);
                layoutContainer.innerHTML = `<p class="text-red-500">Error: Could not load gear.csv. Please ensure the file is in the same directory as this HTML file.</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
